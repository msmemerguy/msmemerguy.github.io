<!DOCTYPE html>

<head>
    <link rel="stylesheet" href="style.css">
</head>

<html>

<body style="margin: 0px; background-color: black;">
    <!-- Import em-fceux. -->
    <script type="text/javascript" src="fceux.js"></script>
    <!-- Contained div for canvas used by em-fceux. -->
    <div style='width: 800px; height: 600px; text-align: center; margin: 0 auto; background: black; color: white; font-family: "Pixel Operator Bold", monospace'>
        <canvas id="mycanvas" tabindex="0"></canvas>
        
        <div id="keys"></div>
    </div>

    <!-- Our app script. -->
    <script>
        // Auto-start NES emulator without a button
        
        function start() {
        
            // Initialize the instance (creates Web Audio etc.)
            fceux.init('#mycanvas');
        
            // Download a game ROM and start it.
            fceux.downloadGame('mantle.nes');
            fceux.setConfig('video-ntsc', true);
            fceux.setConfig('video-tv', true);
        
            // Run the emulation update loop.
            function updateLoop() {
                window.requestAnimationFrame(updateLoop);
                fceux.update();
            }
            window.requestAnimationFrame(updateLoop);
        
            // Bind keyboard input events to controller 1.
            const keys = [
                ['KeyZ', 'A'],
                ['KeyX', 'B'],
                ['KeyA', 'Select'],
                ['KeyS', 'Start'],
                ['ArrowUp', 'Up'],
                ['ArrowDown', 'Down'],
                ['ArrowLeft', 'Left'],
                ['ArrowRight', 'Right'],
            ];
        
            let bits = 0;
        
            function keyHandler(ev) {
                for (let i = 0; i < keys.length; ++i) {
                    if (ev.code === keys[i][0]) {
                        if (ev.type === 'keydown') {
                            bits |= (1 << i);
                        } else {
                            bits &= ~(1 << i);
                        }
                        fceux.setControllerBits(bits);
                        ev.preventDefault();
                    }
                }
            }
            // Unlock WebAudio once
            function unlockAudio() {
                if (fceux?.audioContext?.state === 'suspended') {
                    fceux.audioContext.resume();
                }
            }
            
            // Attach just before starting emulator
            window.addEventListener('click', unlockAudio, { once: true });
            window.addEventListener('keydown', unlockAudio, { once: true });

            window.addEventListener('keydown', keyHandler);
            window.addEventListener('keyup', keyHandler);
        }
        
        // Create the Promise for the em-fceux instance and start automatically.
        FCEUX().then((fceux_) => {
            fceux = fceux_;
        
            function startAfterGesture() {
                fceux.init('#mycanvas');
                start();
                window.removeEventListener('click', startAfterGesture);
                window.removeEventListener('keydown', startAfterGesture);
            }
        
            // require user gesture
            window.addEventListener('click', startAfterGesture);
            window.addEventListener('keydown', startAfterGesture);
        });


    </script>
</body>

</html>
