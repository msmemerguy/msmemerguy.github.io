<!DOCTYPE html>
<head>
 <link rel="stylesheet" href="style.css">
</head>

<html style="height: 100%; background-color: black;">
  <body style="margin: 0px; height: 100%;">
    <!-- Tell fceux.js not to auto-resize the canvas. -->
    <script>
      // Set before loading fceux.js so the script can respect it.
      window.FCEUX_DISABLE_AUTO_RESIZE = true;
    </script>

    <!-- Import em-fceux. -->
    <script type="text/javascript" src="fceux.js"></script>

    <!-- Contained div for canvas used by em-fceux. -->
    <div style="height: 100vh; text-align: center; background: black; color: white; font-family: 'Pixel Operator Bold', monospace;">
      <canvas id="mycanvas" style="height: 100%; width: auto; display: block; margin: 0 auto;"></canvas>
      <div id="button" onclick="start()" style="display: none">
          This half-fangame, half-demake <b style="color: red">contains spoilers</b> for Deltarune Chapter 3.</br>
          <b style="color: yellow">Click here to play in-browser.</b></br>
          (But for best results, download it and use an emulator like Mesen or FCEUX. Thanks.)
      </div>
      <div id="keys"></div>
    </div>

    <!-- Our app script. -->
    <script>
      // Start button and its handler.
      // Note: browsers may block audio initialization if this is not from a user gesture.
      const button = document.querySelector('#button');
      function start() {
        button.style.display = 'none';

        // Initialize the instance (creates Web Audio etc)
        fceux.init('#mycanvas');

        // Download a game ROM and start it.
        fceux.downloadGame('mantle.nes');
        fceux.setConfig('video-ntsc', true);
        fceux.setConfig('video-tv', true);

        // Run the emulation update loop.
        // Use requestAnimationFrame() to synchronise to repaints.
        function updateLoop() {
          window.requestAnimationFrame(updateLoop);
          fceux.update();
        }
        window.requestAnimationFrame(updateLoop);

        // Bind keyboard input events to controller 1.
        const keys = [
          ['KeyZ', 'A'],
          ['KeyX', 'B'],
          ['KeyA', 'Select'],
          ['KeyS', 'Start'],
          ['ArrowUp', 'Up'],
          ['ArrowDown', 'Down'],
          ['ArrowLeft', 'Left'],
          ['ArrowRight', 'Right'],
        ];
        let bits = 0;
        function keyHandler(ev) {
          for (let i = 0; i < keys.length; ++i) {
            if (ev.code == keys[i][0]) {
              if (ev.type == 'keydown') {
                bits |= 1 << i;
              } else {
                bits &= ~(1 << i);
              }
              fceux.setControllerBits(bits);
              ev.preventDefault();
            }
          }
        }
        window.addEventListener('keydown', keyHandler);
        window.addEventListener('keyup', keyHandler);
      }

      // Create the Promise for the em-fceux instance and auto-start.
      FCEUX().then((fceux_) => {
        // Store the instance as global.
        fceux = fceux_;
        // Hide the manual "click to start" UI.
        button.style.display = 'none';

        // Try to auto-start. Note: audio may be blocked by the browser until user interaction.
        try {
          start();
        } catch (e) {
          // If initialisation fails (e.g. due to audio autoplay rules), show the button so the user can click.
          button.style.display = 'block';
          console.warn('Auto-start failed; showing start button. Error:', e);
        }
      }).catch((err) => {
        console.error('FCEUX initialization failed:', err);
        // fallback: show start button so user can attempt manual start
        button.style.display = 'block';
      });
    </script>
  </body>
</html>
